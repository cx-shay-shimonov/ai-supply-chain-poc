# Semantic Code Search POC - File Structure

## Overview
This repository demonstrates tools for detecting AI API and model usage in codebases using semantic search (`sem`) and static analysis (`semgrep`).

---

## ğŸ“ Root Files

### Core Scripts

| File | Type | Description |
|------|------|-------------|
| `ai-usage-audit.sh` | Script | **Main audit script** - Runs both semantic search and semgrep, generates timestamped output folder with CSV comparison, JSON results, and AI asset extraction |
| `sem-audit.sh` | Script | **Semantic-only audit** - Runs semantic search without semgrep, faster for AI model detection |
| `test.sh` | Script | **Quick test script** - Fast semantic search test on ai-ui project with output files |
| `sem-query.py` | Python | **Non-interactive wrapper for sem** - Enables automation, JSON output, token highlighting, and match reasoning for semantic search |
| `ai_asset_extractor.py` | Python | **AI asset extraction module** - DRY module for extracting AI models and providers from search results (OpenAI, Anthropic, Google, Meta, Cohere, Mistral) |

### Configuration Files

| File | Type | Description |
|------|------|-------------|
| `my-detect-openai.yaml` | YAML | **Custom Semgrep rules** - Pattern-based rules for detecting OpenAI and AI API usage |
| `shadow-ai-extended.yaml` | YAML | **Extended Semgrep ruleset** - Additional comprehensive AI detection patterns |
| `.gitignore` | Config | **Git exclusions** - Excludes venv/, output/, projects-samples/*, __pycache__/ |

### Documentation

| File | Type | Description |
|------|------|-------------|
| `README.md` | Docs | **Main documentation** - Setup instructions, overview, tool descriptions, and quick start guide |
| `SEM-EXAMPLES.md` | Docs | **Semantic search examples** - Comprehensive guide to sem tool with real-world queries on OpenHands project |
| `SEMGREP-EXAMPLES.md` | Docs | **Static analysis examples** - Semgrep usage, detection strategies, and output formats |
| `FILE-STRUCTURE.md` | Docs | **This file** - Complete directory and file listing with descriptions |

### Setup & Demo Scripts

| File | Type | Description |
|------|------|-------------|
| `setup-and-demo.sh` | Script | **Interactive setup** - Guided setup for dependencies, embeddings, and demo runs |
| `commands-examples.sh` | Script | **Quick command examples** - 10+ working examples for sem and semgrep |
| `test-samples.sh` | Script | **Validation script** - Quick testing of setup with file counts and embedding status |

### Legacy/Deprecated

| File | Type | Description |
|------|------|-------------|
| `extract-ai-assets.sh` | Script | **Deprecated** - Standalone asset extraction (now integrated into ai-usage-audit.sh) |

---

## ğŸ“‚ Directories

### `projects-samples/`
**Sample projects for testing and demos**

Contains real-world codebases for demonstrating semantic search and static analysis. Projects are cloned separately (excluded from git).

**Structure:**
```
projects-samples/
â”œâ”€â”€ README.md              # Setup instructions and project descriptions
â”œâ”€â”€ ai-ui/                 # Node.js app with OpenAI integration (clone separately)
â”œâ”€â”€ cnas-mfe/              # React/TypeScript micro-frontend (clone separately)
â””â”€â”€ OpenHands/             # Large AI development platform (clone separately)
```

**Clone Commands:**
```bash
cd projects-samples
git clone https://github.com/shayshimonov/ai-ui.git
git clone https://github.com/All-Hands-AI/OpenHands.git
```

---

### `output/`
**Timestamped audit results**

Each audit run creates a new timestamped folder with all results. Files are organized by run.

**Structure:**
```
output/
â””â”€â”€ YYYYMMDD_HHMMSS/       # One folder per audit run
    â”œâ”€â”€ ai_audit_comparison.csv           # CSV comparison of findings
    â”œâ”€â”€ sem_results.json                   # Raw semantic search output
    â”œâ”€â”€ semgrep_results.json               # Raw semgrep output
    â”œâ”€â”€ semantic_ai_providers.json         # Complete semantic results with summary
    â”œâ”€â”€ semantic_assets.json               # Assets only (models/providers)
    â”œâ”€â”€ semgrep_ai_providers.json          # Complete semgrep results with summary
    â””â”€â”€ semgrep_assets.json                # Assets only (models/providers)
```

**Generated by:** `ai-usage-audit.sh`, `sem-audit.sh`

---

**Test script results**

Quick test runs from `test.sh`. Each run creates a timestamped folder.

**Structure:**
```
test-output/
â””â”€â”€ YYYYMMDD_HHMMSS/       # One folder per test run
    â”œâ”€â”€ search_results.json    # Semantic search results (JSON)
    â””â”€â”€ search_results.txt     # Semantic search results (text)
```

**Generated by:** `test.sh`

---

### `venv/`
**Python virtual environment**

Contains all Python dependencies for sem, semgrep, and helper scripts.

**Key packages:**
- `semantic-code-search` - Semantic search tool
- `sentence-transformers` - ML models for code embeddings
- `semgrep` - Static analysis tool
- `torch` - ML framework
- `tree-sitter` - Code parsing

**Created by:** `python3 -m venv venv && venv/bin/pip install ...`

---

### `.git/`
**Git repository**

Version control for the project. Tracks all code, scripts, and documentation.

---

## ğŸ¯ Key Workflows

### Full Audit
```bash
bash ai-usage-audit.sh projects-samples/OpenHands 500
# â†’ Creates output/YYYYMMDD_HHMMSS/ with 7 files
```

### Quick Test
```bash
bash test.sh
# â†’ Creates test-output/YYYYMMDD_HHMMSS/ with 2 files
```

### Direct Semantic Search
```bash
venv/bin/python sem-query.py -p projects-samples/ai-ui -n 10 'OpenAI usage'
# â†’ Prints results to terminal
```

---

## ğŸ“ File Relationships

```
Main Scripts:
  ai-usage-audit.sh
    â”œâ”€â”€ Uses: sem-query.py
    â”œâ”€â”€ Uses: ai_asset_extractor.py
    â”œâ”€â”€ Uses: semgrep (with my-detect-openai.yaml)
    â””â”€â”€ Creates: output/YYYYMMDD_HHMMSS/*

  sem-audit.sh
    â”œâ”€â”€ Uses: sem-query.py
    â”œâ”€â”€ Uses: ai_asset_extractor.py
    â””â”€â”€ Creates: output/YYYYMMDD_HHMMSS/*

  test.sh
    â”œâ”€â”€ Uses: sem-query.py
    â””â”€â”€ Creates: output/YYYYMMDD_HHMMSS/*

Supporting:
  sem-query.py
    â”œâ”€â”€ Uses: venv/lib/.../semantic_code_search
    â”œâ”€â”€ Reads: projects-samples/*/.embeddings
    â””â”€â”€ Enhanced with: arrow_function support patch

  ai_asset_extractor.py
    â”œâ”€â”€ Called by: ai-usage-audit.sh, sem-audit.sh
    â””â”€â”€ Extracts: AI models and providers from JSON results
```

---

## ğŸ”§ Modified Files

### `venv/lib/python3.11/site-packages/semantic_code_search/embed.py`
**Patched to add arrow function support**

Added `'arrow_function'` to `nodes_to_extract` list to detect Express.js route handlers and arrow functions in JavaScript/TypeScript.

```python
# Line 80-81 (patched)
nodes_to_extract = ['function_definition', 'method_definition', 'arrow_function',
                    'function_declaration', 'method_declaration']
```

---

## ğŸ“Š File Sizes (Approximate)

| Category | Files | Size Range |
|----------|-------|------------|
| Scripts | 8 | 1-20 KB each |
| Python modules | 2 | 5-15 KB each |
| Documentation | 4 | 10-100 KB each |
| Config | 2 | 1-5 KB each |
| Output (per run) | 7 | 5 KB - 100 MB |
| venv/ | ~300 MB | Dependencies |

---

## ğŸš€ Getting Started

1. **Setup environment:**
   ```bash
   python3 -m venv venv
   venv/bin/pip install semantic-code-search semgrep
   ```

2. **Clone sample projects:**
   ```bash
   cd projects-samples
   git clone https://github.com/shayshimonov/ai-ui.git
   git clone https://github.com/All-Hands-AI/OpenHands.git
   ```

3. **Run a test:**
   ```bash
   bash test.sh
   ```

4. **Run full audit:**
   ```bash
   bash ai-usage-audit.sh projects-samples/ai-ui 50
   ```

---

## ğŸ“š More Information

- See `README.md` for detailed setup and usage
- See `SEM-EXAMPLES.md` for semantic search examples
- See `SEMGREP-EXAMPLES.md` for static analysis examples
- See `projects-samples/README.md` for sample project details
